# H∆Ø·ªöNG D·∫™N C·∫§U TR√öC NESTJS CHI TI·∫æT

## 1. KH√ÅI NI·ªÜM C∆† BAN

### Module l√† g√¨?
- **Module** = Kh·ªëi x√¢y d·ª±ng (building block) c·ªßa ·ª©ng d·ª•ng NestJS
- Gi·ªëng nh∆∞ m·ªôt "ph√≤ng ban" trong c√¥ng ty, m·ªói ph√≤ng ban c√≥ ch·ª©c nƒÉng ri√™ng
- V√≠ d·ª•: Module Users qu·∫£n l√Ω ng∆∞·ªùi d√πng, Module Posts qu·∫£n l√Ω b√†i vi·∫øt

### Controller l√† g√¨?
- **Controller** = Ng∆∞·ªùi ti·∫øp kh√°ch (receptionist)
- Nh·∫≠n y√™u c·∫ßu (request) t·ª´ client v√† tr·∫£ v·ªÅ ph·∫£n h·ªìi (response)
- ƒê·ªãnh nghƒ©a c√°c endpoint API (GET /users, POST /users, etc.)

### Service l√† g√¨?
- **Service** = Nh√¢n vi√™n x·ª≠ l√Ω c√¥ng vi·ªác th·ª±c t·∫ø
- Ch·ª©a logic nghi·ªáp v·ª• (business logic)
- Controller g·ªçi Service ƒë·ªÉ x·ª≠ l√Ω c√¥ng vi·ªác

### Repository l√† g√¨?
- **Repository** = Th·ªß kho, qu·∫£n l√Ω d·ªØ li·ªáu
- T∆∞∆°ng t√°c tr·ª±c ti·∫øp v·ªõi database
- Service g·ªçi Repository ƒë·ªÉ l·∫•y/l∆∞u d·ªØ li·ªáu

## 2. C·∫§U TR√öC TH∆Ø M·ª§C CHI TI·∫æT

### üìÅ common/ - Nh·ªØng th·ª© d√πng chung
**Gi·∫£i th√≠ch**: ƒê√¢y l√† "kho ƒë·ªì d√πng chung" c·ªßa c·∫£ ·ª©ng d·ª•ng

#### decorators/ - C√°c nh√£n d√°n th√¥ng minh
```typescript
// Thay v√¨ vi·∫øt:
if (user.role !== 'admin') {
  throw new Error('Kh√¥ng c√≥ quy·ªÅn');
}

// Ta ch·ªâ c·∫ßn d√°n nh√£n:
@Roles('admin')
getUserList() {
  // Code ·ªü ƒë√¢y ch·ªâ admin m·ªõi ch·∫°y ƒë∆∞·ª£c
}
```

#### dto/ - Khu√¥n m·∫´u d·ªØ li·ªáu
**DTO = Data Transfer Object** = V·∫≠t chuy·ªÉn t·∫£i d·ªØ li·ªáu
```typescript
// Gi·ªëng nh∆∞ form ƒëƒÉng k√Ω, c√≥ c√°c √¥ c·∫ßn ƒëi·ªÅn:
class CreateUserDto {
  email: string;     // √î email (b·∫Øt bu·ªôc)
  password: string;  // √î m·∫≠t kh·∫©u (b·∫Øt bu·ªôc)
  age?: number;      // √î tu·ªïi (kh√¥ng b·∫Øt bu·ªôc)
}
```

#### exceptions/ - X·ª≠ l√Ω l·ªói
```typescript
// Thay v√¨:
throw new Error('L·ªói g√¨ ƒë√≥');

// Ta t·∫°o l·ªói r√µ r√†ng:
throw new BusinessException('Ng∆∞·ªùi d√πng ƒë√£ t·ªìn t·∫°i');
```

#### filters/ - B·ªô l·ªçc l·ªói
**Gi·∫£i th√≠ch**: Gi·ªëng nh∆∞ "b·ªô ph·∫≠n customer service"
- Khi c√≥ l·ªói x·∫£y ra ‚Üí Filter b·∫Øt l·ªói ‚Üí Tr·∫£ v·ªÅ th√¥ng b√°o ƒë·∫πp cho user
- Kh√¥ng ƒë·ªÉ user th·∫•y l·ªói k·ªπ thu·∫≠t kh√≥ hi·ªÉu

#### guards/ - B·∫£o v·ªá
**Gi·∫£i th√≠ch**: Gi·ªëng nh∆∞ "b·∫£o v·ªá c·ªïng"
```typescript
// Guard ki·ªÉm tra tr∆∞·ªõc khi v√†o:
@UseGuards(AuthGuard)  // Ph·∫£i ƒëƒÉng nh·∫≠p
@UseGuards(RoleGuard)  // Ph·∫£i c√≥ quy·ªÅn admin
deleteUser() {
  // Ch·ªâ admin ƒëƒÉng nh·∫≠p m·ªõi v√†o ƒë∆∞·ª£c ƒë√¢y
}
```

#### interceptors/ - Ng∆∞·ªùi can thi·ªáp
**Gi·∫£i th√≠ch**: Gi·ªëng nh∆∞ "th∆∞ k√Ω"
- **Tr∆∞·ªõc khi x·ª≠ l√Ω**: Ghi log "√îng A ƒëang g·ªçi API X"
- **Sau khi x·ª≠ l√Ω**: Format k·∫øt qu·∫£ ƒë·∫πp tr∆∞·ªõc khi tr·∫£ v·ªÅ

#### middleware/ - Trung gian
**Gi·∫£i th√≠ch**: Gi·ªëng nh∆∞ "l·ªÖ t√¢n kh√°ch s·∫°n"
- M·ªçi request ƒë·ªÅu ph·∫£i qua l·ªÖ t√¢n tr∆∞·ªõc
- L·ªÖ t√¢n ghi s·ªï, ki·ªÉm tra gi·∫•y t·ªù, r·ªìi m·ªõi cho l√™n ph√≤ng

#### pipes/ - ƒê∆∞·ªùng ·ªëng x·ª≠ l√Ω
**Gi·∫£i th√≠ch**: Gi·ªëng nh∆∞ "m√°y l·ªçc n∆∞·ªõc"
```typescript
// D·ªØ li·ªáu v√†o b·∫©n ‚Üí Pipe l·ªçc ‚Üí D·ªØ li·ªáu ra s·∫°ch
Input: "123"        ‚Üí  Pipe  ‚Üí  Output: 123 (number)
Input: "abc123"     ‚Üí  Pipe  ‚Üí  Error: "Ph·∫£i l√† s·ªë"
```

### üìÅ config/ - C·∫•u h√¨nh ·ª©ng d·ª•ng
**Gi·∫£i th√≠ch**: Gi·ªëng nh∆∞ "b·∫£ng ƒëi·ªÅu khi·ªÉn" √¥ t√¥
```typescript
// database.config.ts - C√†i ƒë·∫∑t k·∫øt n·ªëi database
export const databaseConfig = {
  host: 'localhost',      // ƒê·ªãa ch·ªâ m√°y ch·ªß DB
  port: 5432,            // C·ªïng k·∫øt n·ªëi
  username: 'admin',      // T√™n ƒëƒÉng nh·∫≠p
  password: 'password',   // M·∫≠t kh·∫©u
  database: 'myapp'       // T√™n database
};
```

### üìÅ database/ - Qu·∫£n l√Ω c∆° s·ªü d·ªØ li·ªáu

#### migrations/ - L·ªãch s·ª≠ thay ƒë·ªïi DB
**Gi·∫£i th√≠ch**: Gi·ªëng nh∆∞ "s·ªï nh·∫≠t k√Ω thay ƒë·ªïi"
```typescript
// Migration 001: T·∫°o b·∫£ng users
- Ng√†y 1/1/2024: T·∫°o b·∫£ng users v·ªõi c·ªôt id, email, password

// Migration 002: Th√™m c·ªôt age
- Ng√†y 5/1/2024: Th√™m c·ªôt age v√†o b·∫£ng users

// Migration 003: T·∫°o b·∫£ng posts
- Ng√†y 10/1/2024: T·∫°o b·∫£ng posts v·ªõi c·ªôt id, title, content
```

#### seeds/ - D·ªØ li·ªáu m·∫´u
**Gi·∫£i th√≠ch**: Gi·ªëng nh∆∞ "d·ªØ li·ªáu demo"
```typescript
// T·∫°o s·∫µn t√†i kho·∫£n admin ƒë·ªÉ test
{
  email: 'admin@example.com',
  password: 'admin123',
  role: 'admin'
}
```

#### entities/ - M√¥ h√¨nh d·ªØ li·ªáu
**Gi·∫£i th√≠ch**: Gi·ªëng nh∆∞ "b·∫£n thi·∫øt k·∫ø b·∫£ng"
```typescript
// User.entity.ts = Thi·∫øt k·∫ø b·∫£ng users
@Entity('users')
class User {
  @Column()
  id: string;        // C·ªôt id
  
  @Column()
  email: string;     // C·ªôt email
  
  @Column()
  password: string;  // C·ªôt password
}
```

### üìÅ modules/ - C√°c t√≠nh nƒÉng ch√≠nh

#### C·∫•u tr√∫c 1 module (VD: users/)
```
users/
‚îú‚îÄ‚îÄ users.controller.ts    # Ti·∫øp nh·∫≠n request
‚îú‚îÄ‚îÄ users.service.ts       # X·ª≠ l√Ω logic
‚îú‚îÄ‚îÄ users.module.ts        # K·∫øt n·ªëi t·∫•t c·∫£
‚îú‚îÄ‚îÄ dto/                   # Khu√¥n m·∫´u d·ªØ li·ªáu
‚îú‚îÄ‚îÄ entities/              # M√¥ h√¨nh database
‚îú‚îÄ‚îÄ repositories/          # Thao t√°c database
‚îî‚îÄ‚îÄ __tests__/            # Test cases
```

**Lu·ªìng x·ª≠ l√Ω:**
1. **Controller** nh·∫≠n request t·ª´ client
2. **Controller** g·ªçi **Service** ƒë·ªÉ x·ª≠ l√Ω
3. **Service** g·ªçi **Repository** ƒë·ªÉ l·∫•y d·ªØ li·ªáu
4. **Repository** truy v·∫•n database
5. K·∫øt qu·∫£ tr·∫£ ng∆∞·ª£c l·∫°i: Repository ‚Üí Service ‚Üí Controller ‚Üí Client

#### auth/ - X√°c th·ª±c ng∆∞·ªùi d√πng
**Gi·∫£i th√≠ch**: Gi·ªëng nh∆∞ "h·ªá th·ªëng an ninh"
```typescript
// strategies/ - Chi·∫øn l∆∞·ª£c x√°c th·ª±c
- jwt.strategy.ts: Ki·ªÉm tra token JWT
- local.strategy.ts: Ki·ªÉm tra email/password

// guards/ - B·∫£o v·ªá routes
- jwt-auth.guard.ts: Ch·ªâ user ƒëƒÉng nh·∫≠p m·ªõi v√†o ƒë∆∞·ª£c

// dto/ - Form ƒëƒÉng nh·∫≠p/ƒëƒÉng k√Ω
- login.dto.ts: Form ƒëƒÉng nh·∫≠p (email, password)
- register.dto.ts: Form ƒëƒÉng k√Ω (email, password, name)
```

### üìÅ shared/ - Chia s·∫ª gi·ªØa modules

#### services/ - D·ªãch v·ª• chung
```typescript
// email.service.ts - D·ªãch v·ª• g·ª≠i email
class EmailService {
  sendWelcomeEmail(email: string) {
    // G·ª≠i email ch√†o m·ª´ng
  }
  
  sendResetPasswordEmail(email: string) {
    // G·ª≠i email reset m·∫≠t kh·∫©u
  }
}

// cache.service.ts - D·ªãch v·ª• cache
class CacheService {
  set(key: string, value: any) {
    // L∆∞u v√†o cache
  }
  
  get(key: string) {
    // L·∫•y t·ª´ cache
  }
}
```

#### constants/ - H·∫±ng s·ªë ·ª©ng d·ª•ng
```typescript
// app.constants.ts
export const APP_CONSTANTS = {
  DEFAULT_PAGE_SIZE: 10,        // M·ªói trang hi·ªÉn th·ªã 10 item
  MAX_FILE_SIZE: 5 * 1024 * 1024, // T·ªëi ƒëa upload 5MB
  SUPPORTED_FORMATS: ['jpg', 'png', 'pdf']
};

// roles.constants.ts
export enum UserRole {
  ADMIN = 'admin',       // Qu·∫£n tr·ªã vi√™n
  USER = 'user',         // Ng∆∞·ªùi d√πng th∆∞·ªùng
  MODERATOR = 'moderator' // Ng∆∞·ªùi ki·ªÉm duy·ªát
}
```

#### types/ - ƒê·ªãnh nghƒ©a ki·ªÉu d·ªØ li·ªáu
```typescript
// auth.types.ts
interface JwtPayload {
  sub: string;      // ID ng∆∞·ªùi d√πng
  email: string;    // Email ng∆∞·ªùi d√πng
  roles: string[];  // Danh s√°ch quy·ªÅn
}

interface LoginResponse {
  access_token: string;  // Token ƒë·ªÉ truy c·∫≠p
  refresh_token: string; // Token ƒë·ªÉ l√†m m·ªõi
  user: User;           // Th√¥ng tin user
}
```

### üìÅ __tests__/ - Ki·ªÉm th·ª≠ ·ª©ng d·ª•ng

#### e2e/ - Test to√†n b·ªô lu·ªìng
**Gi·∫£i th√≠ch**: Gi·ªëng nh∆∞ "test th·ª±c t·∫ø"
```typescript
// auth.e2e-spec.ts
describe('ƒêƒÉng nh·∫≠p', () => {
  it('ƒêƒÉng nh·∫≠p th√†nh c√¥ng v·ªõi email/password ƒë√∫ng', async () => {
    const result = await request(app)
      .post('/auth/login')
      .send({
        email: 'test@example.com',
        password: 'password123'
      });
    
    expect(result.status).toBe(200);
    expect(result.body.access_token).toBeDefined();
  });
});
```

#### fixtures/ - D·ªØ li·ªáu test
```typescript
// user.fixture.ts - D·ªØ li·ªáu user gi·∫£ ƒë·ªÉ test
export const userFixtures = {
  validUser: {
    email: 'test@example.com',
    password: 'password123',
    name: 'Test User'
  },
  
  invalidUser: {
    email: 'invalid-email',
    password: '123'  // M·∫≠t kh·∫©u qu√° ng·∫Øn
  }
};
```

## 3. LU·ªíNG X·ª¨ L√ù REQUEST

### B∆∞·ªõc 1: Client g·ª≠i request
```
POST /users
{
  "email": "john@example.com",
  "password": "password123"
}
```

### B∆∞·ªõc 2: ƒêi qua Middleware
```typescript
// logger.middleware.ts
console.log('üìù Request: POST /users');
console.log('‚è∞ Time:', new Date());
```

### B∆∞·ªõc 3: ƒêi qua Guards
```typescript
// auth.guard.ts
const token = request.headers.authorization;
if (!token) {
  throw new UnauthorizedException('‚ùå Ch∆∞a ƒëƒÉng nh·∫≠p');
}
```

### B∆∞·ªõc 4: ƒê·∫øn Controller
```typescript
// users.controller.ts
@Post()
async createUser(@Body() createUserDto: CreateUserDto) {
  return this.usersService.create(createUserDto);
}
```

### B∆∞·ªõc 5: ƒêi qua Pipes (Validation)
```typescript
// validation.pipe.ts
if (!createUserDto.email.includes('@')) {
  throw new ValidationException('‚ùå Email kh√¥ng h·ª£p l·ªá');
}
```

### B∆∞·ªõc 6: G·ªçi Service
```typescript
// users.service.ts
async create(createUserDto: CreateUserDto): Promise<User> {
  // Ki·ªÉm tra email ƒë√£ t·ªìn t·∫°i ch∆∞a
  const existingUser = await this.userRepository.findByEmail(createUserDto.email);
  if (existingUser) {
    throw new BusinessException('‚ùå Email ƒë√£ ƒë∆∞·ª£c s·ª≠ d·ª•ng');
  }
  
  // M√£ h√≥a m·∫≠t kh·∫©u
  const hashedPassword = await bcrypt.hash(createUserDto.password, 10);
  
  // T·∫°o user m·ªõi
  const user = await this.userRepository.create({
    ...createUserDto,
    password: hashedPassword
  });
  
  return user;
}
```

### B∆∞·ªõc 7: Repository thao t√°c Database
```typescript
// user.repository.ts
async create(userData: CreateUserDto): Promise<User> {
  const user = this.userRepository.create(userData);
  return await this.userRepository.save(user);
}
```

### B∆∞·ªõc 8: ƒêi qua Interceptors
```typescript
// transform.interceptor.ts
return {
  success: true,
  message: '‚úÖ T·∫°o user th√†nh c√¥ng',
  data: user
};
```

### B∆∞·ªõc 9: Tr·∫£ v·ªÅ Client
```json
{
  "success": true,
  "message": "‚úÖ T·∫°o user th√†nh c√¥ng",
  "data": {
    "id": "123",
    "email": "john@example.com",
    "createdAt": "2024-01-01T10:00:00Z"
  }
}
```

## 4. T·∫†I SAO C·∫¶N C·∫§U TR√öC N√ÄY?

### üéØ Separation of Concerns (Ph√¢n t√°ch tr√°ch nhi·ªám)
- **Controller**: Ch·ªâ lo ti·∫øp nh·∫≠n request v√† tr·∫£ response
- **Service**: Ch·ªâ lo x·ª≠ l√Ω logic nghi·ªáp v·ª•
- **Repository**: Ch·ªâ lo thao t√°c database
- **Guard**: Ch·ªâ lo ki·ªÉm tra quy·ªÅn truy c·∫≠p

### üîÑ T√°i s·ª≠ d·ª•ng (Reusability)
```typescript
// EmailService c√≥ th·ªÉ d√πng ·ªü nhi·ªÅu n∆°i:
- UserService: G·ª≠i email ch√†o m·ª´ng khi ƒëƒÉng k√Ω
- AuthService: G·ª≠i email reset password
- OrderService: G·ª≠i email x√°c nh·∫≠n ƒë∆°n h√†ng
```

### üß™ D·ªÖ test
```typescript
// Test UserService ri√™ng bi·ªát
describe('UserService', () => {
  it('T·∫°o user th√†nh c√¥ng', async () => {
    // Mock repository
    const mockRepository = {
      create: jest.fn().mockResolvedValue(mockUser),
      findByEmail: jest.fn().mockResolvedValue(null)
    };
    
    const userService = new UserService(mockRepository);
    const result = await userService.create(createUserDto);
    
    expect(result).toEqual(mockUser);
  });
});
```

### üìà M·ªü r·ªông d·ªÖ d√†ng
```typescript
// Th√™m t√≠nh nƒÉng m·ªõi ch·ªâ c·∫ßn t·∫°o module m·ªõi
modules/
‚îú‚îÄ‚îÄ users/           # ƒê√£ c√≥
‚îú‚îÄ‚îÄ posts/           # ƒê√£ c√≥
‚îú‚îÄ‚îÄ comments/        # Th√™m m·ªõi
‚îú‚îÄ‚îÄ notifications/   # Th√™m m·ªõi
‚îî‚îÄ‚îÄ payments/        # Th√™m m·ªõi
```

### üë• L√†m vi·ªác nh√≥m hi·ªáu qu·∫£
- Dev A l√†m module Users
- Dev B l√†m module Posts
- Dev C l√†m module Payments
- Kh√¥ng xung ƒë·ªôt code

## 5. QUY T·∫ÆC ƒê·∫∂T T√äN

### File naming
```
user.entity.ts        # Entity
user.service.ts       # Service
user.controller.ts    # Controller
user.repository.ts    # Repository
create-user.dto.ts    # DTO
user.service.spec.ts  # Test file
```

### Class naming
```typescript
class UserEntity { }      # Entity
class UserService { }     # Service
class UserController { }  # Controller
class UserRepository { }  # Repository
class CreateUserDto { }   # DTO
```

### Folder naming
```
kebab-case:
- user-profile/
- order-management/
- email-notifications/
```

## 6. BEST PRACTICES

### 1. Lu√¥n s·ª≠ d·ª•ng DTO cho validation
```typescript
// ‚ùå Kh√¥ng n√™n
@Post()
createUser(@Body() body: any) {
  // Kh√¥ng bi·∫øt body c√≥ g√¨
}

// ‚úÖ N√™n
@Post()
createUser(@Body() createUserDto: CreateUserDto) {
  // ƒê√£ validate v√† type-safe
}
```

### 2. T√°ch bi·ªát Business Logic v√† Data Access
```typescript
// ‚ùå Kh√¥ng n√™n - Logic nghi·ªáp v·ª• trong Controller
@Post()
async createUser(@Body() createUserDto: CreateUserDto) {
  const existingUser = await this.userRepository.findByEmail(createUserDto.email);
  if (existingUser) {
    throw new BadRequestException('Email ƒë√£ t·ªìn t·∫°i');
  }
  // ... logic kh√°c
}

// ‚úÖ N√™n - Logic nghi·ªáp v·ª• trong Service
@Post()
async createUser(@Body() createUserDto: CreateUserDto) {
  return this.userService.create(createUserDto);
}
```

### 3. S·ª≠ d·ª•ng Constants thay v√¨ Hard-code
```typescript
// ‚ùå Kh√¥ng n√™n
if (user.role === 'admin') { }

// ‚úÖ N√™n
if (user.role === UserRole.ADMIN) { }
```

### 4. Error Handling nh·∫•t qu√°n
```typescript
// T·∫°o custom exceptions r√µ r√†ng
export class UserNotFoundException extends NotFoundException {
  constructor(userId: string) {
    super(`Kh√¥ng t√¨m th·∫•y user v·ªõi ID: ${userId}`);
  }
}
```

### 5. Logging ƒë·∫ßy ƒë·ªß
```typescript
@Injectable()
export class UserService {
  private readonly logger = new Logger(UserService.name);

  async create(createUserDto: CreateUserDto): Promise<User> {
    this.logger.log(`T·∫°o user m·ªõi: ${createUserDto.email}`);
    
    try {
      const user = await this.userRepository.create(createUserDto);
      this.logger.log(`‚úÖ T·∫°o user th√†nh c√¥ng: ${user.id}`);
      return user;
    } catch (error) {
      this.logger.error(`‚ùå L·ªói t·∫°o user: ${error.message}`);
      throw error;
    }
  }
}
```

C·∫•u tr√∫c n√†y gi√∫p code **s·∫°ch**, **d·ªÖ hi·ªÉu**, **d·ªÖ maintain** v√† **scalable**!