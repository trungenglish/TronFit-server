# HÆ¯á»šNG DáºªN Cáº¤U TRÃšC NESTJS CHI TIáº¾T

## 1. KHÃI NIá»†M CÆ  BAN

### Module lÃ  gÃ¬?
- **Module** = Khá»‘i xÃ¢y dá»±ng (building block) cá»§a á»©ng dá»¥ng NestJS
- Giá»‘ng nhÆ° má»™t "phÃ²ng ban" trong cÃ´ng ty, má»—i phÃ²ng ban cÃ³ chá»©c nÄƒng riÃªng
- VÃ­ dá»¥: Module Users quáº£n lÃ½ ngÆ°á»i dÃ¹ng, Module Posts quáº£n lÃ½ bÃ i viáº¿t

### Controller lÃ  gÃ¬?
- **Controller** = NgÆ°á»i tiáº¿p khÃ¡ch (receptionist)
- Nháº­n yÃªu cáº§u (request) tá»« client vÃ  tráº£ vá» pháº£n há»“i (response)
- Äá»‹nh nghÄ©a cÃ¡c endpoint API (GET /users, POST /users, etc.)

### Service lÃ  gÃ¬?
- **Service** = NhÃ¢n viÃªn xá»­ lÃ½ cÃ´ng viá»‡c thá»±c táº¿
- Chá»©a logic nghiá»‡p vá»¥ (business logic)
- Controller gá»i Service Ä‘á»ƒ xá»­ lÃ½ cÃ´ng viá»‡c

### Repository lÃ  gÃ¬?
- **Repository** = Thá»§ kho, quáº£n lÃ½ dá»¯ liá»‡u
- TÆ°Æ¡ng tÃ¡c trá»±c tiáº¿p vá»›i database
- Service gá»i Repository Ä‘á»ƒ láº¥y/lÆ°u dá»¯ liá»‡u

## 2. Cáº¤U TRÃšC THÆ¯ Má»¤C CHI TIáº¾T

### ğŸ“ common/ - Nhá»¯ng thá»© dÃ¹ng chung
**Giáº£i thÃ­ch**: ÄÃ¢y lÃ  "kho Ä‘á»“ dÃ¹ng chung" cá»§a cáº£ á»©ng dá»¥ng

#### decorators/ - CÃ¡c nhÃ£n dÃ¡n thÃ´ng minh
```typescript
// Thay vÃ¬ viáº¿t:
if (user.role !== 'admin') {
  throw new Error('KhÃ´ng cÃ³ quyá»n');
}

// Ta chá»‰ cáº§n dÃ¡n nhÃ£n:
@Roles('admin')
getUserList() {
  // Code á»Ÿ Ä‘Ã¢y chá»‰ admin má»›i cháº¡y Ä‘Æ°á»£c
}
```

#### dto/ - KhuÃ´n máº«u dá»¯ liá»‡u
**DTO = Data Transfer Object** = Váº­t chuyá»ƒn táº£i dá»¯ liá»‡u
```typescript
// Giá»‘ng nhÆ° form Ä‘Äƒng kÃ½, cÃ³ cÃ¡c Ã´ cáº§n Ä‘iá»n:
class CreateUserDto {
  email: string;     // Ã” email (báº¯t buá»™c)
  password: string;  // Ã” máº­t kháº©u (báº¯t buá»™c)
  age?: number;      // Ã” tuá»•i (khÃ´ng báº¯t buá»™c)
}
```

#### exceptions/ - Xá»­ lÃ½ lá»—i
```typescript
// Thay vÃ¬:
throw new Error('Lá»—i gÃ¬ Ä‘Ã³');

// Ta táº¡o lá»—i rÃµ rÃ ng:
throw new BusinessException('NgÆ°á»i dÃ¹ng Ä‘Ã£ tá»“n táº¡i');
```

#### filters/ - Bá»™ lá»c lá»—i
**Giáº£i thÃ­ch**: Giá»‘ng nhÆ° "bá»™ pháº­n customer service"
- Khi cÃ³ lá»—i xáº£y ra â†’ Filter báº¯t lá»—i â†’ Tráº£ vá» thÃ´ng bÃ¡o Ä‘áº¹p cho user
- KhÃ´ng Ä‘á»ƒ user tháº¥y lá»—i ká»¹ thuáº­t khÃ³ hiá»ƒu

#### guards/ - Báº£o vá»‡
**Giáº£i thÃ­ch**: Giá»‘ng nhÆ° "báº£o vá»‡ cá»•ng"
```typescript
// Guard kiá»ƒm tra trÆ°á»›c khi vÃ o:
@UseGuards(AuthGuard)  // Pháº£i Ä‘Äƒng nháº­p
@UseGuards(RoleGuard)  // Pháº£i cÃ³ quyá»n admin
deleteUser() {
  // Chá»‰ admin Ä‘Äƒng nháº­p má»›i vÃ o Ä‘Æ°á»£c Ä‘Ã¢y
}
```

#### interceptors/ - NgÆ°á»i can thiá»‡p
**Giáº£i thÃ­ch**: Giá»‘ng nhÆ° "thÆ° kÃ½"
- **TrÆ°á»›c khi xá»­ lÃ½**: Ghi log "Ã”ng A Ä‘ang gá»i API X"
- **Sau khi xá»­ lÃ½**: Format káº¿t quáº£ Ä‘áº¹p trÆ°á»›c khi tráº£ vá»

#### middleware/ - Trung gian
**Giáº£i thÃ­ch**: Giá»‘ng nhÆ° "lá»… tÃ¢n khÃ¡ch sáº¡n"
- Má»i request Ä‘á»u pháº£i qua lá»… tÃ¢n trÆ°á»›c
- Lá»… tÃ¢n ghi sá»•, kiá»ƒm tra giáº¥y tá», rá»“i má»›i cho lÃªn phÃ²ng

#### pipes/ - ÄÆ°á»ng á»‘ng xá»­ lÃ½
**Giáº£i thÃ­ch**: Giá»‘ng nhÆ° "mÃ¡y lá»c nÆ°á»›c"
```typescript
// Dá»¯ liá»‡u vÃ o báº©n â†’ Pipe lá»c â†’ Dá»¯ liá»‡u ra sáº¡ch
Input: "123"        â†’  Pipe  â†’  Output: 123 (number)
Input: "abc123"     â†’  Pipe  â†’  Error: "Pháº£i lÃ  sá»‘"
```

### ğŸ“ config/ - Cáº¥u hÃ¬nh á»©ng dá»¥ng
**Giáº£i thÃ­ch**: Giá»‘ng nhÆ° "báº£ng Ä‘iá»u khiá»ƒn" Ã´ tÃ´
```typescript
// database.config.ts - CÃ i Ä‘áº·t káº¿t ná»‘i database
export const databaseConfig = {
  host: 'localhost',      // Äá»‹a chá»‰ mÃ¡y chá»§ DB
  port: 5432,            // Cá»•ng káº¿t ná»‘i
  username: 'admin',      // TÃªn Ä‘Äƒng nháº­p
  password: 'password',   // Máº­t kháº©u
  database: 'myapp'       // TÃªn database
};
```

### ğŸ“ database/ - Quáº£n lÃ½ cÆ¡ sá»Ÿ dá»¯ liá»‡u

#### migrations/ - Lá»‹ch sá»­ thay Ä‘á»•i DB
**Giáº£i thÃ­ch**: Giá»‘ng nhÆ° "sá»• nháº­t kÃ½ thay Ä‘á»•i"
```typescript
// Migration 001: Táº¡o báº£ng users
- NgÃ y 1/1/2024: Táº¡o báº£ng users vá»›i cá»™t id, email, password

// Migration 002: ThÃªm cá»™t age
- NgÃ y 5/1/2024: ThÃªm cá»™t age vÃ o báº£ng users

// Migration 003: Táº¡o báº£ng posts
- NgÃ y 10/1/2024: Táº¡o báº£ng posts vá»›i cá»™t id, title, content
```

#### seeds/ - Dá»¯ liá»‡u máº«u
**Giáº£i thÃ­ch**: Giá»‘ng nhÆ° "dá»¯ liá»‡u demo"
```typescript
// Táº¡o sáºµn tÃ i khoáº£n admin Ä‘á»ƒ test
{
  email: 'admin@example.com',
  password: 'admin123',
  role: 'admin'
}
```

#### entities/ - MÃ´ hÃ¬nh dá»¯ liá»‡u
**Giáº£i thÃ­ch**: Giá»‘ng nhÆ° "báº£n thiáº¿t káº¿ báº£ng"
```typescript
// User.entity.ts = Thiáº¿t káº¿ báº£ng users
@Entity('users')
class User {
  @Column()
  id: string;        // Cá»™t id
  
  @Column()
  email: string;     // Cá»™t email
  
  @Column()
  password: string;  // Cá»™t password
}
```

### ğŸ“ modules/ - CÃ¡c tÃ­nh nÄƒng chÃ­nh

#### Cáº¥u trÃºc 1 module (VD: users/)
```
users/
â”œâ”€â”€ users.controller.ts    # Tiáº¿p nháº­n request
â”œâ”€â”€ users.service.ts       # Xá»­ lÃ½ logic
â”œâ”€â”€ users.module.ts        # Káº¿t ná»‘i táº¥t cáº£
â”œâ”€â”€ dto/                   # KhuÃ´n máº«u dá»¯ liá»‡u
â”œâ”€â”€ entities/              # MÃ´ hÃ¬nh database
â”œâ”€â”€ repositories/          # Thao tÃ¡c database
â””â”€â”€ __tests__/            # Test cases
```

**Luá»“ng xá»­ lÃ½:**
1. **Controller** nháº­n request tá»« client
2. **Controller** gá»i **Service** Ä‘á»ƒ xá»­ lÃ½
3. **Service** gá»i **Repository** Ä‘á»ƒ láº¥y dá»¯ liá»‡u
4. **Repository** truy váº¥n database
5. Káº¿t quáº£ tráº£ ngÆ°á»£c láº¡i: Repository â†’ Service â†’ Controller â†’ Client

#### auth/ - XÃ¡c thá»±c ngÆ°á»i dÃ¹ng
**Giáº£i thÃ­ch**: Giá»‘ng nhÆ° "há»‡ thá»‘ng an ninh"
```typescript
// strategies/ - Chiáº¿n lÆ°á»£c xÃ¡c thá»±c
- jwt.strategy.ts: Kiá»ƒm tra token JWT
- local.strategy.ts: Kiá»ƒm tra email/password

// guards/ - Báº£o vá»‡ routes
- jwt-auth.guard.ts: Chá»‰ user Ä‘Äƒng nháº­p má»›i vÃ o Ä‘Æ°á»£c

// dto/ - Form Ä‘Äƒng nháº­p/Ä‘Äƒng kÃ½
- login.dto.ts: Form Ä‘Äƒng nháº­p (email, password)
- register.dto.ts: Form Ä‘Äƒng kÃ½ (email, password, name)
```

### ğŸ“ shared/ - Chia sáº» giá»¯a modules

#### services/ - Dá»‹ch vá»¥ chung
```typescript
// email.service.ts - Dá»‹ch vá»¥ gá»­i email
class EmailService {
  sendWelcomeEmail(email: string) {
    // Gá»­i email chÃ o má»«ng
  }
  
  sendResetPasswordEmail(email: string) {
    // Gá»­i email reset máº­t kháº©u
  }
}

// cache.service.ts - Dá»‹ch vá»¥ cache
class CacheService {
  set(key: string, value: any) {
    // LÆ°u vÃ o cache
  }
  
  get(key: string) {
    // Láº¥y tá»« cache
  }
}
```

#### constants/ - Háº±ng sá»‘ á»©ng dá»¥ng
```typescript
// app.constants.ts
export const APP_CONSTANTS = {
  DEFAULT_PAGE_SIZE: 10,        // Má»—i trang hiá»ƒn thá»‹ 10 item
  MAX_FILE_SIZE: 5 * 1024 * 1024, // Tá»‘i Ä‘a upload 5MB
  SUPPORTED_FORMATS: ['jpg', 'png', 'pdf']
};

// roles.constants.ts
export enum UserRole {
  ADMIN = 'admin',       // Quáº£n trá»‹ viÃªn
  USER = 'user',         // NgÆ°á»i dÃ¹ng thÆ°á»ng
  MODERATOR = 'moderator' // NgÆ°á»i kiá»ƒm duyá»‡t
}
```

#### types/ - Äá»‹nh nghÄ©a kiá»ƒu dá»¯ liá»‡u
```typescript
// auth.types.ts
interface JwtPayload {
  sub: string;      // ID ngÆ°á»i dÃ¹ng
  email: string;    // Email ngÆ°á»i dÃ¹ng
  roles: string[];  // Danh sÃ¡ch quyá»n
}

interface LoginResponse {
  access_token: string;  // Token Ä‘á»ƒ truy cáº­p
  refresh_token: string; // Token Ä‘á»ƒ lÃ m má»›i
  user: User;           // ThÃ´ng tin user
}
```

### ğŸ“ __tests__/ - Kiá»ƒm thá»­ á»©ng dá»¥ng

#### e2e/ - Test toÃ n bá»™ luá»“ng
**Giáº£i thÃ­ch**: Giá»‘ng nhÆ° "test thá»±c táº¿"
```typescript
// auth.e2e-spec.ts
describe('ÄÄƒng nháº­p', () => {
  it('ÄÄƒng nháº­p thÃ nh cÃ´ng vá»›i email/password Ä‘Ãºng', async () => {
    const result = await request(app)
      .post('/auth/login')
      .send({
        email: 'test@example.com',
        password: 'password123'
      });
    
    expect(result.status).toBe(200);
    expect(result.body.access_token).toBeDefined();
  });
});
```

#### fixtures/ - Dá»¯ liá»‡u test
```typescript
// user.fixture.ts - Dá»¯ liá»‡u user giáº£ Ä‘á»ƒ test
export const userFixtures = {
  validUser: {
    email: 'test@example.com',
    password: 'password123',
    name: 'Test User'
  },
  
  invalidUser: {
    email: 'invalid-email',
    password: '123'  // Máº­t kháº©u quÃ¡ ngáº¯n
  }
};
```

## 3. LUá»’NG Xá»¬ LÃ REQUEST

### BÆ°á»›c 1: Client gá»­i request
```
POST /users
{
  "email": "john@example.com",
  "password": "password123"
}
```

### BÆ°á»›c 2: Äi qua Middleware
```typescript
// logger.middleware.ts
console.log('ğŸ“ Request: POST /users');
console.log('â° Time:', new Date());
```

### BÆ°á»›c 3: Äi qua Guards
```typescript
// auth.guard.ts
const token = request.headers.authorization;
if (!token) {
  throw new UnauthorizedException('âŒ ChÆ°a Ä‘Äƒng nháº­p');
}
```

### BÆ°á»›c 4: Äáº¿n Controller
```typescript
// users.controller.ts
@Post()
async createUser(@Body() createUserDto: CreateUserDto) {
  return this.usersService.create(createUserDto);
}
```

### BÆ°á»›c 5: Äi qua Pipes (Validation)
```typescript
// validation.pipe.ts
if (!createUserDto.email.includes('@')) {
  throw new ValidationException('âŒ Email khÃ´ng há»£p lá»‡');
}
```

### BÆ°á»›c 6: Gá»i Service
```typescript
// users.service.ts
async create(createUserDto: CreateUserDto): Promise<User> {
  // Kiá»ƒm tra email Ä‘Ã£ tá»“n táº¡i chÆ°a
  const existingUser = await this.userRepository.findByEmail(createUserDto.email);
  if (existingUser) {
    throw new BusinessException('âŒ Email Ä‘Ã£ Ä‘Æ°á»£c sá»­ dá»¥ng');
  }
  
  // MÃ£ hÃ³a máº­t kháº©u
  const hashedPassword = await bcrypt.hash(createUserDto.password, 10);
  
  // Táº¡o user má»›i
  const user = await this.userRepository.create({
    ...createUserDto,
    password: hashedPassword
  });
  
  return user;
}
```

### BÆ°á»›c 7: Repository thao tÃ¡c Database
```typescript
// user.repository.ts
async create(userData: CreateUserDto): Promise<User> {
  const user = this.userRepository.create(userData);
  return await this.userRepository.save(user);
}
```

### BÆ°á»›c 8: Äi qua Interceptors
```typescript
// transform.interceptor.ts
return {
  success: true,
  message: 'âœ… Táº¡o user thÃ nh cÃ´ng',
  data: user
};
```

### BÆ°á»›c 9: Tráº£ vá» Client
```json
{
  "success": true,
  "message": "âœ… Táº¡o user thÃ nh cÃ´ng",
  "data": {
    "id": "123",
    "email": "john@example.com",
    "createdAt": "2024-01-01T10:00:00Z"
  }
}
```

## 4. Táº I SAO Cáº¦N Cáº¤U TRÃšC NÃ€Y?

### ğŸ¯ Separation of Concerns (PhÃ¢n tÃ¡ch trÃ¡ch nhiá»‡m)
- **Controller**: Chá»‰ lo tiáº¿p nháº­n request vÃ  tráº£ response
- **Service**: Chá»‰ lo xá»­ lÃ½ logic nghiá»‡p vá»¥
- **Repository**: Chá»‰ lo thao tÃ¡c database
- **Guard**: Chá»‰ lo kiá»ƒm tra quyá»n truy cáº­p

### ğŸ”„ TÃ¡i sá»­ dá»¥ng (Reusability)
```typescript
// EmailService cÃ³ thá»ƒ dÃ¹ng á»Ÿ nhiá»u nÆ¡i:
- UserService: Gá»­i email chÃ o má»«ng khi Ä‘Äƒng kÃ½
- AuthService: Gá»­i email reset password
- OrderService: Gá»­i email xÃ¡c nháº­n Ä‘Æ¡n hÃ ng
```

### ğŸ§ª Dá»… test
```typescript
// Test UserService riÃªng biá»‡t
describe('UserService', () => {
  it('Táº¡o user thÃ nh cÃ´ng', async () => {
    // Mock repository
    const mockRepository = {
      create: jest.fn().mockResolvedValue(mockUser),
      findByEmail: jest.fn().mockResolvedValue(null)
    };
    
    const userService = new UserService(mockRepository);
    const result = await userService.create(createUserDto);
    
    expect(result).toEqual(mockUser);
  });
});
```

### ğŸ“ˆ Má»Ÿ rá»™ng dá»… dÃ ng
```typescript
// ThÃªm tÃ­nh nÄƒng má»›i chá»‰ cáº§n táº¡o module má»›i
modules/
â”œâ”€â”€ users/           # ÄÃ£ cÃ³
â”œâ”€â”€ posts/           # ÄÃ£ cÃ³
â”œâ”€â”€ comments/        # ThÃªm má»›i
â”œâ”€â”€ notifications/   # ThÃªm má»›i
â””â”€â”€ payments/        # ThÃªm má»›i
```

### ğŸ‘¥ LÃ m viá»‡c nhÃ³m hiá»‡u quáº£
- Dev A lÃ m module Users
- Dev B lÃ m module Posts
- Dev C lÃ m module Payments
- KhÃ´ng xung Ä‘á»™t code

## 5. QUY Táº®C Äáº¶T TÃŠN

### File naming
```
user.entity.ts        # Entity
user.service.ts       # Service
user.controller.ts    # Controller
user.repository.ts    # Repository
create-user.dto.ts    # DTO
user.service.spec.ts  # Test file
```

### Class naming
```typescript
class UserEntity { }      # Entity
class UserService { }     # Service
class UserController { }  # Controller
class UserRepository { }  # Repository
class CreateUserDto { }   # DTO
```

### Folder naming
```
kebab-case:
- user-profile/
- order-management/
- email-notifications/
```

## 6. BEST PRACTICES

### 1. LuÃ´n sá»­ dá»¥ng DTO cho validation
```typescript
// âŒ KhÃ´ng nÃªn
@Post()
createUser(@Body() body: any) {
  // KhÃ´ng biáº¿t body cÃ³ gÃ¬
}

// âœ… NÃªn
@Post()
createUser(@Body() createUserDto: CreateUserDto) {
  // ÄÃ£ validate vÃ  type-safe
}
```

### 2. TÃ¡ch biá»‡t Business Logic vÃ  Data Access
```typescript
// âŒ KhÃ´ng nÃªn - Logic nghiá»‡p vá»¥ trong Controller
@Post()
async createUser(@Body() createUserDto: CreateUserDto) {
  const existingUser = await this.userRepository.findByEmail(createUserDto.email);
  if (existingUser) {
    throw new BadRequestException('Email Ä‘Ã£ tá»“n táº¡i');
  }
  // ... logic khÃ¡c
}

// âœ… NÃªn - Logic nghiá»‡p vá»¥ trong Service
@Post()
async createUser(@Body() createUserDto: CreateUserDto) {
  return this.userService.create(createUserDto);
}
```

### 3. Sá»­ dá»¥ng Constants thay vÃ¬ Hard-code
```typescript
// âŒ KhÃ´ng nÃªn
if (user.role === 'admin') { }

// âœ… NÃªn
if (user.role === UserRole.ADMIN) { }
```

### 4. Error Handling nháº¥t quÃ¡n
```typescript
// Táº¡o custom exceptions rÃµ rÃ ng
export class UserNotFoundException extends NotFoundException {
  constructor(userId: string) {
    super(`KhÃ´ng tÃ¬m tháº¥y user vá»›i ID: ${userId}`);
  }
}
```

### 5. Logging Ä‘áº§y Ä‘á»§
```typescript
@Injectable()
export class UserService {
  private readonly logger = new Logger(UserService.name);

  async create(createUserDto: CreateUserDto): Promise<User> {
    this.logger.log(`Táº¡o user má»›i: ${createUserDto.email}`);
    
    try {
      const user = await this.userRepository.create(createUserDto);
      this.logger.log(`âœ… Táº¡o user thÃ nh cÃ´ng: ${user.id}`);
      return user;
    } catch (error) {
      this.logger.error(`âŒ Lá»—i táº¡o user: ${error.message}`);
      throw error;
    }
  }
}
```

Cáº¥u trÃºc nÃ y giÃºp code **sáº¡ch**, **dá»… hiá»ƒu**, **dá»… maintain** vÃ  **scalable**!